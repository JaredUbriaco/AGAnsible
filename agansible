#!/bin/bash
# AGAnsible CLI Wrapper
# Unified command-line interface for AGAnsible suite

set -e

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Get script directory
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
cd "$SCRIPT_DIR"

# Version
VERSION="1.0.0"

# Help function
show_help() {
    cat << EOF
${CYAN}AGAnsible CLI${NC} - Unified command-line interface for AGAnsible suite
Version: $VERSION

${GREEN}USAGE:${NC}
    agansible <command> [options]

${GREEN}COMMANDS:${NC}
    ${CYAN}install${NC}           Install all required dependencies
        Options:
            --skip-failed      Continue installation even if some packages fail
            --no-progress      Disable progress indicators

    ${CYAN}verify${NC}             Verify installation and setup
        Checks: Ansible, Python, playbooks, configuration

    ${CYAN}test${NC}                Run test suite
        Options:
            --verbose, -v      Show detailed output
            --playbook <name>  Run specific playbook only
            --format <fmt>     Output format: text, json, both

    ${CYAN}run${NC}                 Run a specific playbook
        Usage: agansible run <playbook_path> [ansible-playbook options]
        Example: agansible run playbooks/base/ping_test.yml

    ${CYAN}list${NC}                List available playbooks
        Shows all playbooks organized by category

    ${CYAN}vault${NC}               Ansible Vault operations (delegates to ansible-vault)
        create <file>         Create encrypted vault file
        edit <file>           Edit encrypted vault file
        view <file>           View decrypted vault file
        encrypt-string [str]  Encrypt a string (use --name 'var_name' for YAML name)

    ${CYAN}version${NC}             Show version information

    ${CYAN}help${NC}                Show this help message

${GREEN}EXAMPLES:${NC}
    agansible install
    agansible verify
    agansible test
    agansible vault create group_vars/cisco-devices/vault.yml
    agansible vault edit group_vars/cisco-devices/vault.yml
    agansible vault encrypt-string 'secret' --name ansible_password
    agansible run playbooks/base/ping_test.yml

${GREEN}For more information, see README.md${NC}
EOF
}

# Install command
cmd_install() {
    echo -e "${BLUE}Running AGAnsible installation...${NC}"
    if [ -f "./install.sh" ]; then
        bash ./install.sh "$@"
    else
        echo -e "${RED}Error: install.sh not found${NC}"
        exit 1
    fi
}

# Verify command
cmd_verify() {
    echo -e "${BLUE}Verifying AGAnsible installation...${NC}"
    if [ -f "./verify.sh" ]; then
        bash ./verify.sh
    else
        echo -e "${RED}Error: verify.sh not found${NC}"
        exit 1
    fi
}

# Test command
cmd_test() {
    local verbose=false
    local playbook_filter=""
    local format=""
    
    # Parse options
    while [[ $# -gt 0 ]]; do
        case $1 in
            --verbose|-v)
                verbose=true
                shift
                ;;
            --playbook)
                playbook_filter="$2"
                shift 2
                ;;
            --format)
                format="$2"
                shift 2
                ;;
            *)
                echo -e "${RED}Unknown option: $1${NC}"
                show_help
                exit 1
                ;;
        esac
    done
    
    echo -e "${BLUE}Running AGAnsible test suite...${NC}"
    
    if [ -f "./test_all.sh" ]; then
        local test_cmd="./test_all.sh"
        if [ "$verbose" = true ]; then
            test_cmd="$test_cmd --verbose"
        fi
        
        if [ -n "$format" ]; then
            export ANSIBLE_OUTPUT_FORMAT="$format"
        fi
        
        bash $test_cmd
    else
        echo -e "${RED}Error: test_all.sh not found${NC}"
        exit 1
    fi
}

# Run command
cmd_run() {
    if [ $# -lt 1 ]; then
        echo -e "${RED}Error: Playbook path required${NC}"
        echo "Usage: agansible run <playbook_path> [ansible-playbook options]"
        exit 1
    fi
    
    local playbook="$1"
    shift
    
    if [ ! -f "$playbook" ]; then
        echo -e "${RED}Error: Playbook not found: $playbook${NC}"
        exit 1
    fi
    
    echo -e "${BLUE}Running playbook: $playbook${NC}"
    ansible-playbook "$playbook" "$@"
}

# List command
cmd_list() {
    echo -e "${CYAN}Available Playbooks:${NC}"
    echo ""
    
    if [ -d "playbooks" ]; then
        for category in playbooks/*/; do
            if [ -d "$category" ]; then
                category_name=$(basename "$category")
                echo -e "${GREEN}${category_name^} Playbooks:${NC}"
                for playbook in "$category"*.yml; do
                    if [ -f "$playbook" ]; then
                        playbook_name=$(basename "$playbook")
                        echo "  - $playbook"
                    fi
                done
                echo ""
            fi
        done
    else
        echo -e "${YELLOW}No playbooks directory found${NC}"
    fi
}

# Vault command (delegates to ansible-vault)
cmd_vault() {
    if [ $# -lt 1 ]; then
        echo -e "${RED}Error: vault subcommand required${NC}"
        echo "Usage: agansible vault { create | edit | view | encrypt-string } [options] [file|string]"
        echo "  create <file>         - ansible-vault create <file>"
        echo "  edit <file>           - ansible-vault edit <file>"
        echo "  view <file>           - ansible-vault view <file>"
        echo "  encrypt-string [str] - ansible-vault encrypt_string [string] (pass --name 'var_name' for YAML)"
        exit 1
    fi
    
    local subcmd="$1"
    shift
    
    if ! command -v ansible-vault &> /dev/null; then
        echo -e "${RED}Error: ansible-vault not found. Run: agansible install${NC}"
        exit 1
    fi
    
    case "$subcmd" in
        create)
            if [ $# -lt 1 ]; then
                echo -e "${RED}Error: file path required${NC}"
                echo "Usage: agansible vault create <file>"
                exit 1
            fi
            echo -e "${BLUE}Creating vault file (ansible-vault create)...${NC}"
            ansible-vault create "$@"
            ;;
        edit)
            if [ $# -lt 1 ]; then
                echo -e "${RED}Error: file path required${NC}"
                echo "Usage: agansible vault edit <file>"
                exit 1
            fi
            ansible-vault edit "$@"
            ;;
        view)
            if [ $# -lt 1 ]; then
                echo -e "${RED}Error: file path required${NC}"
                echo "Usage: agansible vault view <file>"
                exit 1
            fi
            ansible-vault view "$@"
            ;;
        encrypt-string)
            ansible-vault encrypt_string "$@"
            ;;
        *)
            echo -e "${RED}Unknown vault subcommand: $subcmd${NC}"
            echo "Use: create | edit | view | encrypt-string"
            exit 1
            ;;
    esac
}

# Version command
cmd_version() {
    echo "AGAnsible CLI Version: $VERSION"
    if command -v ansible &> /dev/null; then
        echo "Ansible Version: $(ansible --version | head -1)"
    else
        echo "Ansible: Not installed"
    fi
    if command -v python3 &> /dev/null; then
        echo "Python Version: $(python3 --version)"
    else
        echo "Python3: Not installed"
    fi
}

# Main command dispatcher
main() {
    if [ $# -eq 0 ]; then
        show_help
        exit 0
    fi
    
    local command="$1"
    shift
    
    case "$command" in
        install)
            cmd_install "$@"
            ;;
        verify)
            cmd_verify "$@"
            ;;
        test)
            cmd_test "$@"
            ;;
        run)
            cmd_run "$@"
            ;;
        list)
            cmd_list "$@"
            ;;
        vault)
            cmd_vault "$@"
            ;;
        version)
            cmd_version "$@"
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            echo -e "${RED}Unknown command: $command${NC}"
            echo ""
            show_help
            exit 1
            ;;
    esac
}

# Run main function
main "$@"
