---
# Cisco-specific SSH connectivity test
# Requires: Cisco device with SSH enabled
# Inventory should define: ansible_connection=network_cli or ansible_connection=ansible.netcommon.network_cli

- name: Test SSH connectivity to Cisco device
  hosts: cisco-routers
  gather_facts: no
  
  vars:
    # Playbook metadata
    playbook_version: "1.0.0"
    playbook_author: "AGAnsible Team"
    playbook_description: "SSH connectivity test for Cisco network devices with fallback to local ping test"
    
    # Playbook variables
    actionlog_dir: "{{ playbook_dir }}/../../actionlog/cisco/ssh_test"
    test_timeout: 30
  
  tasks:
    - name: Setup actionlog directory
      import_tasks: ../../../roles/common/tasks/actionlog_setup.yml
      
    - name: Check if this is a local test (no actual Cisco device)
      set_fact:
        is_local_test: "{{ ansible_connection == 'local' or ansible_host is not defined }}"
        
    - name: Test SSH connection by running show version (Cisco IOS)
      cisco.ios.ios_command:
        commands:
          - show version
      register: version_output
      failed_when: false
      when: not is_local_test
      
    - name: Validate SSH connection success (Cisco device)
      set_fact:
        test_status: "{{ 'SUCCESS' if (version_output.failed is not defined or not version_output.failed) else 'FAILURE' }}"
        test_message: "{{ 'SSH connection successful' if (version_output.failed is not defined or not version_output.failed) else 'SSH connection failed: ' + (version_output.msg | default('Connection timeout or authentication failed')) }}"
        device_info: "{{ version_output.stdout_lines[0] | default([]) if (version_output.stdout_lines is defined) else [] }}"
      when: not is_local_test
      
    - name: Fallback - Test basic Ansible ping module (local test)
      ansible.builtin.ping:
      register: ping_test
      failed_when: false
      when: is_local_test
      
    - name: Validate local ping test
      set_fact:
        test_status: "{{ 'SUCCESS' if (ping_test.ping is defined) else 'FAILURE' }}"
        test_message: "{{ 'Ansible ping successful (local test mode)' if (ping_test.ping is defined) else 'Ansible ping failed' }}"
        device_info: []
      when: is_local_test
      
    - name: Generate timestamp
      import_tasks: ../../../roles/common/tasks/timestamp.yml
    
    - name: Prepare actionlog data structure
      set_fact:
        actionlog_data:
          test_name: "SSH Test"
          timestamp: "{{ timestamp }}"
          host: "{{ inventory_hostname }}"
          status: "{{ test_status }}"
          message: "{{ test_message }}"
          details:
            connection_type: "{{ ansible_connection | default('local') }}"
            test_mode: "{{ 'Local Test' if is_local_test else 'Cisco Device Test' }}"
            device_info: "{{ device_info | default([]) }}"
          metrics:
            is_local_test: "{{ is_local_test }}"
            ssh_connection_successful: "{{ test_status == 'SUCCESS' }}"
          validation:
            ssh_connection: "{{ 'PASS' if test_status == 'SUCCESS' else 'FAIL' }}"
            device_response: "{{ 'PASS' if (device_info | length > 0 or is_local_test) else 'FAIL' }}"
            test_completed: "PASS"
          full_output: "{{ version_output | to_nice_yaml if (not is_local_test and version_output is defined) else (ping_test | to_nice_yaml if (is_local_test and ping_test is defined) else 'N/A') }}"
          playbook_metadata:
            version: "{{ playbook_version }}"
            author: "{{ playbook_author }}"
            description: "{{ playbook_description }}"
    
    - name: Write test results to actionlog
      import_tasks: ../../../roles/common/tasks/write_actionlog.yml
      vars:
        actionlog_filename: "ssh_test_{{ inventory_hostname }}_{{ timestamp | replace(':', '-') | replace('+', '-') }}"
    
    - name: Display test results
      debug:
        msg:
          - "Test Status: {{ test_status }}"
          - "{{ test_message }}"
          - "Output Format: {{ output_format | default('text') }}"
          - "Results saved to: {{ actionlog_dir }}/ssh_test_{{ inventory_hostname }}_{{ timestamp | replace(':', '-') | replace('+', '-') }}.{{ 'json' if (output_format | default('text')) == 'json' else 'txt' }}"
          
    - name: Fail if SSH test was unsuccessful
      fail:
        msg: "SSH test FAILED - {{ test_message }}"
      when: test_status == "FAILURE" and not is_local_test
      
    - name: Note about SSH test configuration
      debug:
        msg: "For actual Cisco SSH test, ensure inventory has ansible_connection=network_cli and credentials configured in group_vars or host_vars"
      when: is_local_test
