---
# Agnostic ping test - works on any system
- name: Ping test to Google DNS (8.8.8.8)
  hosts: all
  gather_facts: no
  connection: local
  
  vars:
    # Playbook metadata
    playbook_version: "1.0.0"
    playbook_author: "AGAnsible Team"
    playbook_description: "Network connectivity test using ICMP ping to a target host"
    
    # Playbook variables
    actionlog_dir: "{{ playbook_dir }}/../../actionlog/base/ping_test"
    target_host: "8.8.8.8"
    ping_count: 4
  
  tasks:
    - name: Setup actionlog directory
      import_tasks: ../../../roles/common/tasks/actionlog_setup.yml
      
    - name: Ping {{ target_host }} using command module
      command: ping -c {{ ping_count }} {{ target_host }}
      register: ping_result
      failed_when: false
      changed_when: false
      retries: "{{ retry_default_attempts | default(3) }}"
      delay: "{{ retry_default_delay | default(2) }}"
      until: ping_result.rc == 0 or ping_result.rc == 1  # 0 = success, 1 = some packets lost but command succeeded
      
    - name: Extract packet loss from ping results
      set_fact:
        packet_loss_match: "{{ ping_result.stdout | regex_search('([0-9]+)% packet loss') | default(['100']) }}"
        packets_transmitted_match: "{{ ping_result.stdout | regex_search('([0-9]+) packets transmitted') | default(['0']) }}"
        packets_received_match: "{{ ping_result.stdout | regex_search('([0-9]+) received') | default(['0']) }}"
        
    - name: Extract numeric values
      set_fact:
        packet_loss: "{{ (packet_loss_match | first | default('100')) | int }}"
        packets_transmitted: "{{ (packets_transmitted_match | first | default('0')) | int }}"
        packets_received: "{{ (packets_received_match | first | default('0')) | int }}"
        
    - name: Validate ping test success
      set_fact:
        test_status: "{{ 'SUCCESS' if packet_loss < 100 and packets_received > 0 else 'FAILURE' }}"
        test_message: "{{ 'All packets received' if packet_loss == 0 else 'Packet loss detected: ' + (packet_loss | string) + '%' }}"
        
    - name: Generate timestamp
      import_tasks: ../../../roles/common/tasks/timestamp.yml
    
    - name: Prepare actionlog data structure
      set_fact:
        actionlog_data:
          test_name: "Ping Test"
          timestamp: "{{ timestamp }}"
          host: "{{ inventory_hostname }}"
          status: "{{ test_status }}"
          message: "{{ test_message }}"
          details:
            target_host: "{{ target_host }}"
            ping_count: "{{ ping_count }}"
          metrics:
            packet_loss_percent: "{{ packet_loss }}"
            packets_transmitted: "{{ packets_transmitted }}"
            packets_received: "{{ packets_received }}"
          validation:
            packet_loss_under_100: "{{ 'PASS' if packet_loss < 100 else 'FAIL' }}"
            packets_received_gt_zero: "{{ 'PASS' if packets_received > 0 else 'FAIL' }}"
          full_output: "{{ ping_result.stdout }}"
          playbook_metadata:
            version: "{{ playbook_version }}"
            author: "{{ playbook_author }}"
            description: "{{ playbook_description }}"
    
    - name: Write test results to actionlog
      import_tasks: ../../../roles/common/tasks/write_actionlog.yml
      vars:
        actionlog_filename: "ping_test_{{ inventory_hostname }}_{{ timestamp | replace(':', '-') | replace('+', '-') }}"
    
    - name: Display ping results
      debug:
        msg:
          - "Test Status: {{ test_status }}"
          - "{{ test_message }}"
          - "Packet Loss: {{ packet_loss }}%"
          - "Output Format: {{ output_format | default('text') }}"
          - "Results saved to: {{ actionlog_dir }}/ping_test_{{ inventory_hostname }}_{{ timestamp | replace(':', '-') | replace('+', '-') }}.{{ 'json' if (output_format | default('text')) == 'json' else 'txt' }}"
          
    - name: Fail if ping test was unsuccessful
      fail:
        msg: "Ping test FAILED - {{ test_message }}"
      when: test_status == "FAILURE"
