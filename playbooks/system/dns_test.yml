---
# System-level DNS test
# Tests DNS resolution using a specific DNS server
# Requires: dig or nslookup to be installed on target system

- name: DNS resolution test for zappos.com using Cloudflare DNS (1.1.1.1)
  hosts: all
  gather_facts: no
  
  vars:
    # Playbook metadata
    playbook_version: "1.0.0"
    playbook_author: "AGAnsible Team"
    playbook_description: "DNS resolution test using a specific DNS server to validate domain name resolution"
    
    # Playbook variables
    actionlog_dir: "{{ playbook_dir }}/../../actionlog/system/dns_test"
    target_domain: "zappos.com"
    dns_server: "1.1.1.1"
    test_timeout: 10
  
  tasks:
    - name: Setup actionlog directory
      import_tasks: "{{ playbook_dir }}/../../roles/common/tasks/actionlog_setup.yml"
      
    - name: Check if dig is installed
      command: which dig
      register: dig_check
      changed_when: false
      failed_when: false
      
    - name: Check if nslookup is installed
      command: which nslookup
      register: nslookup_check
      changed_when: false
      failed_when: false
      
    - name: Validate DNS tool availability
      set_fact:
        dns_tool_available: "{{ dig_check.rc == 0 or nslookup_check.rc == 0 }}"
        use_dig: "{{ dig_check.rc == 0 }}"
        use_nslookup: "{{ nslookup_check.rc == 0 and dig_check.rc != 0 }}"
        dns_tool: "{{ 'dig' if dig_check.rc == 0 else 'nslookup' }}"
        
    - name: Fail if no DNS tool is available
      fail:
        msg: "Neither dig nor nslookup is installed. Install with: sudo apt-get install dnsutils (Debian/Ubuntu) or sudo yum install bind-utils (RHEL/CentOS)"
      when: not dns_tool_available
      
    - name: Perform DNS lookup using dig
      command: dig @{{ dns_server }} {{ target_domain }} +timeout={{ test_timeout }} +short
      register: dns_result_dig
      failed_when: false
      changed_when: false
      when: use_dig
      
    - name: Perform DNS lookup using nslookup
      command: nslookup {{ target_domain }} {{ dns_server }}
      register: dns_result_nslookup
      failed_when: false
      changed_when: false
      when: use_nslookup
      
    - name: Set DNS result based on tool used
      set_fact:
        dns_result: "{{ dns_result_dig if use_dig else dns_result_nslookup }}"
        dns_output: "{{ dns_result_dig.stdout if use_dig else dns_result_nslookup.stdout }}"
        dns_rc: "{{ dns_result_dig.rc if use_dig else dns_result_nslookup.rc }}"
        
    - name: Extract IP addresses from dig output
      set_fact:
        resolved_ips: "{{ dns_output.split('\n') | select('match', '^[0-9]+\\.[0-9]+\\.[0-9]+\\.[0-9]+$') | list }}"
      when: use_dig
      
    - name: Extract IP addresses from nslookup output
      set_fact:
        resolved_ips: "{{ dns_output | regex_findall('Address: ([0-9]+\\.[0-9]+\\.[0-9]+\\.[0-9]+)') | map('last') | list }}"
      when: use_nslookup
      
    - name: Validate DNS resolution success
      set_fact:
        test_status: "{{ 'SUCCESS' if (dns_rc == 0 and resolved_ips | length > 0) else 'FAILURE' }}"
        test_message: "{{ 'DNS resolution successful' if (dns_rc == 0 and resolved_ips | length > 0) else 'DNS resolution failed or no IP addresses found' }}"
        ip_count: "{{ resolved_ips | length }}"
        
    - name: Generate timestamp
      import_tasks: "{{ playbook_dir }}/../../roles/common/tasks/timestamp.yml"
    
    - name: Prepare actionlog data structure
      set_fact:
        actionlog_data:
          test_name: "DNS Test"
          timestamp: "{{ timestamp }}"
          host: "{{ inventory_hostname }}"
          status: "{{ test_status }}"
          message: "{{ test_message }}"
          details:
            target_domain: "{{ target_domain }}"
            dns_server: "{{ dns_server }}"
            dns_tool: "{{ dns_tool }}"
            dns_tool_available: "{{ dns_tool_available }}"
          metrics:
            ip_count: "{{ ip_count }}"
            resolved_ips: "{{ resolved_ips }}"
          validation:
            dns_tool_installed: "{{ 'PASS' if dns_tool_available else 'FAIL' }}"
            dns_resolution: "{{ 'PASS' if test_status == 'SUCCESS' else 'FAIL' }}"
            ip_addresses_found: "{{ 'PASS' if ip_count > 0 else 'FAIL' }}"
            dns_server_response: "{{ 'PASS' if dns_rc == 0 else 'FAIL' }}"
          full_output: "{{ dns_output }}"
          playbook_metadata:
            version: "{{ playbook_version }}"
            author: "{{ playbook_author }}"
            description: "{{ playbook_description }}"
    
    - name: Write test results to actionlog
      import_tasks: "{{ playbook_dir }}/../../roles/common/tasks/write_actionlog.yml"
      vars:
        actionlog_filename: "dns_test_{{ inventory_hostname }}_{{ timestamp | replace(':', '-') | replace('+', '-') }}"
    
    - name: Display test results
      debug:
        msg:
          - "Test Status: {{ test_status }}"
          - "{{ test_message }}"
          - "DNS Server: {{ dns_server }}"
          - "Resolved IPs: {{ resolved_ips | join(', ') }}"
          - "Output Format: {{ output_format | default('text') }}"
          - "Results saved to: {{ actionlog_dir }}/dns_test_{{ inventory_hostname }}_{{ timestamp | replace(':', '-') | replace('+', '-') }}.{{ 'json' if (output_format | default('text')) == 'json' else 'txt' }}"
          
    - name: Fail if DNS test was unsuccessful
      fail:
        msg: "DNS test FAILED - {{ test_message }}"
      when: test_status == "FAILURE"
