---
# System-level curl test
# Requires: curl to be installed on target system

- name: Curl test to external URL
  hosts: all
  gather_facts: no
  
  vars:
    # Playbook metadata
    playbook_version: "1.0.0"
    playbook_author: "AGAnsible Team"
    playbook_description: "HTTP/HTTPS connectivity test using curl to validate web service accessibility"
    
    # Playbook variables
    actionlog_dir: "{{ playbook_dir }}/../../actionlog/system/curl_test"
    test_urls:
      - url: "https://httpbin.org/get"
        expected_status: 200
        description: "HTTPBin GET test"
      - url: "https://www.google.com"
        expected_status: 200
        description: "Google connectivity test"
  
  tasks:
    - name: Setup actionlog directory
      import_tasks: "{{ playbook_dir }}/../../roles/common/tasks/actionlog_setup.yml"
      
    - name: Check if curl is installed
      command: which curl
      register: curl_check
      changed_when: false
      failed_when: false
      
    - name: Validate curl installation
      set_fact:
        curl_installed: "{{ curl_check.rc == 0 }}"
        curl_path: "{{ curl_check.stdout if curl_check.rc == 0 else 'NOT FOUND' }}"
        
    - name: Fail if curl is not installed
      fail:
        msg: "curl is not installed on the target system. Install with: apt-get install curl (Debian/Ubuntu) or yum install curl (RHEL/CentOS)"
      when: not curl_installed
      
    - name: Test curl to each URL
      uri:
        url: "{{ item.url }}"
        method: GET
        return_content: yes
        status_code: "{{ item.expected_status }}"
        timeout: 10
      register: curl_results
      loop: "{{ test_urls }}"
      failed_when: false
      changed_when: false
      
    - name: Validate curl test results
      set_fact:
        test_results: "{{ test_results | default([]) + [{
          'url': item.item.url,
          'description': item.item.description,
          'expected_status': item.item.expected_status,
          'actual_status': item.status | default('N/A'),
          'success': (item.status | default(0) | int) == (item.item.expected_status | int),
          'response_time': item.elapsed | default('N/A'),
          'content_length': item.content_length | default('N/A')
        }] }}"
      loop: "{{ curl_results.results | default([]) }}"
      
    - name: Calculate overall test status
      set_fact:
        overall_status: "{{ 'SUCCESS' if (test_results | selectattr('success', 'equalto', true) | list | length) == (test_results | length) else 'FAILURE' }}"
        success_count: "{{ test_results | selectattr('success', 'equalto', true) | list | length }}"
        total_count: "{{ test_results | length }}"
        
    - name: Generate timestamp
      import_tasks: "{{ playbook_dir }}/../../roles/common/tasks/timestamp.yml"
    
    - name: Prepare actionlog data structure
      set_fact:
        actionlog_data:
          test_name: "Curl Test"
          timestamp: "{{ timestamp }}"
          host: "{{ inventory_hostname }}"
          status: "{{ overall_status }}"
          message: "HTTP/HTTPS connectivity test completed - {{ success_count }}/{{ total_count }} tests passed"
          details:
            curl_installed: "{{ curl_installed }}"
            curl_path: "{{ curl_path }}"
            test_urls: "{{ test_urls }}"
          metrics:
            success_count: "{{ success_count }}"
            total_count: "{{ total_count }}"
            test_results: "{{ test_results }}"
          validation:
            curl_installation: "{{ 'PASS' if curl_installed else 'FAIL' }}"
            all_urls_accessible: "{{ 'PASS' if overall_status == 'SUCCESS' else 'FAIL' }}"
            http_status_codes: "{{ 'PASS' if overall_status == 'SUCCESS' else 'FAIL' }}"
          full_output: "{{ curl_results | to_nice_yaml }}"
          playbook_metadata:
            version: "{{ playbook_version }}"
            author: "{{ playbook_author }}"
            description: "{{ playbook_description }}"
    
    - name: Write test results to actionlog
      import_tasks: "{{ playbook_dir }}/../../roles/common/tasks/write_actionlog.yml"
      vars:
        actionlog_filename: "curl_test_{{ inventory_hostname }}_{{ timestamp | replace(':', '-') | replace('+', '-') }}"
    
    - name: Display test results
      debug:
        msg:
          - "Overall Status: {{ overall_status }}"
          - "Tests Passed: {{ success_count }}/{{ total_count }}"
          - "Output Format: {{ output_format | default('text') }}"
          - "Results saved to: {{ actionlog_dir }}/curl_test_{{ inventory_hostname }}_{{ timestamp | replace(':', '-') | replace('+', '-') }}.{{ 'json' if (output_format | default('text')) == 'json' else 'txt' }}"
      loop: "{{ test_results }}"
      loop_control:
        label: "{{ item.description }}: {{ 'PASS' if item.success else 'FAIL' }} ({{ item.actual_status }})"
        
    - name: Fail if curl tests were unsuccessful
      fail:
        msg: "Curl test FAILED - {{ success_count }}/{{ total_count }} tests passed"
      when: overall_status == "FAILURE"
